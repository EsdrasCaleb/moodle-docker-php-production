services:
  db:
    image: postgres:18.1
    environment:
      POSTGRES_USER: moodle
      POSTGRES_PASSWORD: password
      POSTGRES_DB: moodle
    volumes:
      - db_data:/var/lib/postgresql/18/docker

  memcached:
    image: memcached:1.6-alpine
    command: memcached
    ports:
      - "11211:11211"

  app:
    build:
      context: .
      dockerfile: DockerfileAlpine
    ports:
      - "80:80"
    depends_on:
      - db
      - memcached
    environment:
      MOODLE_URL: http://localhost

      DB_HOST: db
      DB_TYPE: pgsql
      DB_NAME: moodle
      DB_USER: moodle
      DB_PASS: password

      MOODLE_VERSION: MOODLE_405_STABLE
      MOODLE_LANG: pt_br

      MOODLE_ADMIN_USER: admin
      MOODLE_ADMIN_PASS: MoodleAdmin123!
      MOODLE_ADMIN_EMAIL: admin@example.com

      PHP_MEMORY_LIMIT: 512M
      PHP_MAX_EXECUTION_TIME: 600

      PLUGIN_CODE_STATUS: update
      SITE_CODE_STATUS: update
      SERVER_MEMORY_USAGE_PERCENT: 20

      MOODLE_PLUGINS_JSON: |
        [
          {
            "giturl": "https://github.com/h5p/moodle-mod_hvp.git",
            "branch": "stable",
            "installpath": "mod/hvp"
          },
          {
            "giturl": "https://github.com/davosmith/moodle-checklist.git",
            "branch": "master",
            "installpath": "mod/checklist"
          }
        ]

      # ðŸ”¥ MEMCACHED + SESSION HANDLER
      MOODLE_EXTRA_PHP: |
        $$CFG->debug = 32767;
        $$CFG->debugdisplay = 1;

        $$CFG->session_handler_class = '\core\session\memcached';
        $$CFG->session_memcached_save_path = 'memcached:11211';
        $$CFG->session_memcached_prefix = 'moodle_';
        $$CFG->session_memcached_acquire_lock_timeout = 120;
        $$CFG->session_memcached_lock_expire = 7200;

        $$CFG->cachestore_memcached_servers = 'memcached:11211';

    volumes:
      - moodle_data:/var/www/moodledata
    dns:
      - 8.8.8.8
      - 1.1.1.1

volumes:
  db_data:
  moodle_data:
